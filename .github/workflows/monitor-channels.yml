# Monitor YouTube Channels for New Videos
#
# This workflow runs daily to check configured YouTube channels for new videos
# and automatically processes them through the summarizer pipeline.
#
# Required Secrets (set in GitHub repo settings > Secrets and variables > Actions):
#   - CRON_SECRET: Secure token to authenticate with the monitor endpoint
#   - SITE_URL: Your deployed site URL (e.g., https://your-site.netlify.app)
#
# To test manually:
#   1. Go to Actions tab > Monitor YouTube Channels
#   2. Click "Run workflow"
#   3. Optionally enable dry run mode to check without processing

name: Monitor YouTube Channels

on:
  schedule:
    # Run daily at 6 AM UTC
    # Cron format: minute hour day-of-month month day-of-week
    - cron: '0 6 * * *'

  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (check channels without processing videos)'
        required: false
        default: 'false'
        type: boolean

jobs:
  monitor:
    name: Check Channels for New Videos
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "Error: CRON_SECRET is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SITE_URL }}" ]; then
            echo "Error: SITE_URL is not set"
            exit 1
          fi
          echo "Secrets validated successfully"

      - name: Trigger channel monitoring
        id: monitor
        run: |
          echo "Calling monitor endpoint at ${{ secrets.SITE_URL }}/api/channels/monitor"
          echo "Dry run: ${{ github.event.inputs.dry_run || 'false' }}"

          # Make the API call and capture both response and status code
          HTTP_RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{"dryRun": ${{ github.event.inputs.dry_run || false }}}' \
            "${{ secrets.SITE_URL }}/api/channels/monitor")

          # Extract the body and status
          HTTP_BODY=$(echo $HTTP_RESPONSE | sed -e 's/HTTPSTATUS\:.*//g')
          HTTP_STATUS=$(echo $HTTP_RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')

          echo "HTTP Status: $HTTP_STATUS"

          # Save response for next step
          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$HTTP_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "status=$HTTP_STATUS" >> $GITHUB_OUTPUT

          # Check if request was successful
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "Error: Request failed with status $HTTP_STATUS"
            echo "Response: $HTTP_BODY"
            exit 1
          fi

          echo "Channel monitoring completed successfully"

      - name: Display results
        if: always()
        run: |
          echo "=== Channel Monitoring Results ==="
          echo '${{ steps.monitor.outputs.response }}' | jq . 2>/dev/null || echo '${{ steps.monitor.outputs.response }}'

      - name: Check for failures
        if: steps.monitor.outputs.status == '200'
        run: |
          # Parse the response and check for failed channels
          FAILED=$(echo '${{ steps.monitor.outputs.response }}' | jq -r '.summary.failedChannels // 0')
          PROCESSED=$(echo '${{ steps.monitor.outputs.response }}' | jq -r '.summary.videosProcessed // 0')

          echo "Videos processed: $PROCESSED"
          echo "Channels failed: $FAILED"

          if [ "$FAILED" -gt 0 ]; then
            echo "Warning: $FAILED channel(s) failed to check"
            # Don't fail the workflow for partial failures
            # The successful channels were still processed
          fi

      - name: Summary
        if: always()
        run: |
          echo "### Channel Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.monitor.outputs.status }}" = "200" ]; then
            TOTAL=$(echo '${{ steps.monitor.outputs.response }}' | jq -r '.summary.totalChannels // 0')
            SUCCESS=$(echo '${{ steps.monitor.outputs.response }}' | jq -r '.summary.successfulChannels // 0')
            FAILED=$(echo '${{ steps.monitor.outputs.response }}' | jq -r '.summary.failedChannels // 0')
            PROCESSED=$(echo '${{ steps.monitor.outputs.response }}' | jq -r '.summary.videosProcessed // 0')
            SKIPPED=$(echo '${{ steps.monitor.outputs.response }}' | jq -r '.summary.videosSkipped // 0')

            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Channels | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Successful | $SUCCESS |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| Videos Processed | $PROCESSED |" >> $GITHUB_STEP_SUMMARY
            echo "| Videos Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** Failed with HTTP ${{ steps.monitor.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          fi
